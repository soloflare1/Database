# 🔥 `HAVING`--

## 🔷 What is `HAVING`?

* `HAVING` is a SQL clause used to **filter grouped results**.
* It always works **with `GROUP BY`**.
* It filters data **after aggregation**, unlike `WHERE`, which filters **before**.

Think of it like:

> "Group the data, calculate things like average or count, then show only the groups I care about."

---

## 🧠 Why Do We Need `HAVING`?

* You **can’t** use aggregate functions (like `AVG()`, `SUM()`, `COUNT()`) inside `WHERE`.
* So when you need to **filter by aggregates**, you must use `HAVING`.

✅ `HAVING` → to filter **groups**
❌ `WHERE` → can't be used to filter based on group summaries

---

## ⚙️ How `HAVING` Works (Step-by-Step)

Here’s how SQL runs your query (in logical order):

1. **`FROM`** — Pick the table
2. **`WHERE`** — Filter individual rows
3. **`GROUP BY`** — Group the remaining rows
4. **Aggregate Functions** — Calculate `COUNT`, `AVG`, etc.
5. **`HAVING`** — Filter those group results
6. **`SELECT`** — Choose what to return
7. **`ORDER BY`** — Sort the final result

---

## 📌 When to Use `HAVING`

Use `HAVING` if:

* You're using `GROUP BY`
* You want to filter **after aggregation**
* You need questions like:

  * “Which departments have more than 5 employees?”
  * “Which cities have an average score above 80?”
  * “Which products were sold more than 100 times?”

---

## ✅ Syntax Pattern

```sql
SELECT column, AGG_FUNC(column2)
FROM table
WHERE condition            -- (optional) filter rows first
GROUP BY column
HAVING aggregate_condition -- filter grouped results
ORDER BY column;
```

---

## 🔎 Examples 

**1. Count students per city, but only cities with more than 2 students:**

```sql
SELECT city, COUNT(*) AS student_count
FROM students
GROUP BY city
HAVING COUNT(*) > 2;
```

**2. Show grades with average marks above 80:**

```sql
SELECT grade, AVG(marks) AS avg_marks
FROM students
GROUP BY grade
HAVING AVG(marks) > 80;
```

**3. Filter groups using multiple conditions:**

```sql
SELECT city, COUNT(*) AS total_students, AVG(marks) AS avg_score
FROM students
GROUP BY city
HAVING COUNT(*) >= 2 AND AVG(marks) > 70;
```

---

## 🧠 Difference Between `WHERE` and `HAVING`

| Feature        | `WHERE`                | `HAVING`                 |
| -------------- | ---------------------- | ------------------------ |
| Filters        | Individual rows        | Groups after aggregation |
| Aggregate use  | ❌ Can't use aggregates | ✅ Can use aggregates     |
| Execution Time | Before grouping        | After grouping           |
| Works with     | Any query              | Only with `GROUP BY`     |

---

## ❗ Common Mistakes

| Mistake                                        | Explanation                          | Fix                                         |
| ---------------------------------------------- | ------------------------------------ | ------------------------------------------- |
| Using `SUM()`, `AVG()` in `WHERE`              | Aggregates aren't available yet      | Move to `HAVING`                            |
| Referencing alias in `HAVING` (in some DBs)    | Not always supported                 | Use full expression (`HAVING COUNT(*) > 2`) |
| Selecting a non-grouped, non-aggregated column | SQL doesn’t know which value to show | Either group it or aggregate it             |

---

## 💡 Best Practices

* ✅ Use `WHERE` to reduce data **before grouping** (for better performance).
* ✅ Use `HAVING` to apply filters **after aggregation**.
* ✅ Use full aggregate expressions in `HAVING` (`HAVING COUNT(*) > 2`).
* ✅ Keep queries readable by using clear aliases in `SELECT`.

---

## 🔁 Recap: Mental Model

1. **Think of `GROUP BY` as buckets**
2. **Aggregate functions** summarize each bucket
3. **`HAVING`** filters which buckets to keep

---
